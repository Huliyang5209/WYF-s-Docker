见版本V4.0.0
# 问题引入
上篇中，我们实现了-v命令，通过挂载宿主机上的文件，类似文件共享，实现了容器的文件持久化
但我们的容器在退出后，已经会把可写层的内容删除掉
在我们使用docker的过程，我们会使用commit命令，将正在运行中的容器进行保存，成一个新的镜像，当启动这个镜像时，我们在可写层的东西依旧存在
本篇中我们就要实现这个功能的基础，当然没有像docker那样，能直接commit成一个新的镜像
本篇中如书中所说，简单的镜像打包
其中核心的就是将我们的挂载点镜像打包即可，因为挂载点中，挂载着busybox基础只读层、可写层、宿主机的挂载数据卷，即存放着我们当前的所有数据
所以我们直接将其进行打包即可

由于代码逻辑较为简单，故直接上代码
# 代码实现

```go
func main() {
	......

	app.Commands = []cli.Command{
		runCommand,
		initCommand,
		CommitCommand,
	}

	......
}
```

```go
var CommitCommand=cli.Command{
    Name:"commit",
	Usage:"commit a container into image",
	Action:func(context *cli.Context)error{
	    if len(context.Args()) < 1 {
			return fmt.Errorf("Missing container name")
		}
		imageName := context.Args().Get(0)
		return run.CommitContainer(imageName)
	},
}
```

```go
func CommitContainer(imageName string) error {
	pwd, err := os.Getwd()
	if err != nil {
		return fmt.Errorf("Run get pwd err: %v", err)
	}
	mntUrl := pwd + "/mnt/"
	imageTar := pwd + "/" + imageName + ".tar"
	log.Infof("commit file path: %s", imageTar)
	if _, err := exec.Command("tar", "-czf", imageTar, "-C", mntUrl, ".").CombinedOutput(); err != nil {
		return fmt.Errorf("tar folder err: %s, %v", mntUrl, err)
	}
	log.Infof("end commit file: %s", imageTar)
	return nil
}
```

# 结果：

```shell
[root@localhost WYFdocker]# ./WYFdocker commit image
{"level":"info","msg":"commit file path: /home/gocodes/WYFdocker/image.tar","time":"2024-05-03T18:58:55+08:00"}
{"level":"info","msg":"end commit file: /home/gocodes/WYFdocker/image.tar","time":"2024-05-03T18:58:55+08:00"}
[root@localhost WYFdocker]# ls
busybox  CommandCallbackFunction  docs    go.sum     main_command.go  mnt               pkg         WYFdocker
Cgroups  container                go.mod  image.tar  main.go          mydocker-cgroups  writelayer
[root@localhost WYFdocker]# mkdir ./untar
[root@localhost WYFdocker]# cd untar
[root@localhost untar]# ls
[root@localhost untar]# tar -xvf ../image.tar
[root@localhost untar]# ls
bin  dev  etc  hello.txt  home  mydocker-cgroups  proc  root  sys  tmp  usr  var
```

```shell
[root@localhost WYFdocker]# ./WYFdocker run -ti sh
{"level":"info","msg":"resConf:\u0026{  }","time":"2024-05-03T18:58:12+08:00"}
{"level":"info","msg":"createTty true","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"RunUrl is /home/gocodes/WYFdocker/","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"MntUrl is /home/gocodes/WYFdocker/mnt/","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"createMountPoint is running--------------------------","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"createMountPoint is end---------------------","time":"2024-05-03T18:58:12+08:00"}
{"level":"info","msg":"parent process run","time":"2024-05-03T18:58:12+08:00"}
{"level":"info","msg":"all command is  sh","time":"2024-05-03T18:58:12+08:00"}
{"level":"info","msg":"init come on","time":"2024-05-03T18:58:12+08:00"}
{"level":"info","msg":"command:","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"setupmout is running-------------------------------","time":"2024-05-03T18:58:12+08:00"}
{"level":"info","msg":"current location: /home/gocodes/WYFdocker/mnt","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"privot root is running-------------------------------","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"privot root is end-------------------------------","time":"2024-05-03T18:58:12+08:00"}
{"level":"error","msg":"setupmout is end-------------------------------","time":"2024-05-03T18:58:12+08:00"}
{"level":"info","msg":"find path /bin/sh","time":"2024-05-03T18:58:12+08:00"}
/ # ls
bin               etc               home              proc              sys               usr
dev               hello.txt         mydocker-cgroups  root              tmp               var
```

